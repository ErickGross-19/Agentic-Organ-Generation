# Stress Tests

This document describes the stress test DesignSpec files located in `examples/stress_tests/`. These tests are intentionally extreme configurations designed to push the system to its limits.

## Warning

These stress tests are designed to be computationally intensive and may exceed available memory or time limits on typical hardware. They are intended for:

- Benchmarking system performance
- Testing edge cases and boundary conditions
- Validating that the system handles extreme configurations gracefully
- Profiling memory and CPU usage

Do not expect these tests to complete quickly or successfully on resource-constrained systems.

## Shared Configuration

All three stress tests share the following domain geometry:

- Domain: Cylinder with radius 10mm (0.01m) and height 30mm (0.03m), centered at origin
- Ridge: Height 5mm (0.005m), thickness 0.5mm (0.0005m), on top face
- Ports: 5 inlets on top face (z = +0.015m):
  - 1 at center [0, 0, 0.015]
  - 4 around at radius 6mm: [±0.006, 0, 0.015] and [0, ±0.006, 0.015]
  - Inlet radius: 1mm (0.001m)
  - Direction: [0, 0, -1] (pointing downward into domain)

Target terminal radius: 25 microns (2.5e-05 m)
Target voxel pitch: 1 micron (1e-06 m)

## Stress Test 1: Scaffold Top-Down Dense

**File:** `stress_scaffold_topdown_dense_embed.json`

**Backend:** `scaffold_topdown`

This test uses the scaffold top-down backend with extremely dense branching parameters:

- 3 splits per node (ternary branching)
- 10 levels deep
- Radius ratio 0.70 per level
- Step length 3mm with 0.98 decay
- Spread 5mm with 0.98 decay
- Cone angle 85 degrees
- Jitter 25 degrees
- Curvature 0.45 with 9 curve samples

Collision handling uses merge-on-collision with 128 rotation attempts and up to 400 attempts per child.

## Stress Test 2: Space Colonization Dense

**File:** `stress_space_colonization_dense_embed.json`

**Backend:** `space_colonization`

This test uses the space colonization backend with multi-inlet forest_with_merge mode:

- 500,000 attraction points
- 2500 max iterations
- Step size 0.75mm
- Influence radius 4mm
- Kill radius 0.5mm
- Collision merge distance 0.5mm

Bifurcation is encouraged with:
- Max 3 children per node
- 95% bifurcation probability
- Min 2 attractions for bifurcation
- 25 degree angle threshold
- Taper factor 0.85

## Stress Test 3: Programmatic Pathfinding Dense

**File:** `stress_programmatic_pathfinding_dense_embed.json`

**Backend:** `programmatic`

This test uses the programmatic backend with A* voxel pathfinding and a complex step plan:

- Path algorithm: `astar_voxel`
- Collision strategy order: `["reroute", "voxel_merge_fallback", "shrink", "terminate"]`
- Taper factor 0.80
- Min radius 25 microns

The step plan is generated by `scripts/generate_programmatic_stress_plan.py` and includes:
- 5 inlet nodes (one per inlet)
- Spiral/helical trunk paths with 10 waypoints each
- Binary tree branching at 3 points along each trunk (depth 7, ~128 terminals per inlet)
- Total: ~7700 steps (3865 ADD_NODE + 3860 ROUTE operations)

### Regenerating the Programmatic Stress Plan

To regenerate the programmatic stress test spec with updated parameters:

```bash
python scripts/generate_programmatic_stress_plan.py
```

This will overwrite `examples/stress_tests/stress_programmatic_pathfinding_dense_embed.json` with freshly generated steps.

## Running the Stress Tests

To run a stress test using the DesignSpecRunner:

```python
from designspec import DesignSpec, DesignSpecRunner

spec = DesignSpec.from_json("examples/stress_tests/stress_scaffold_topdown_dense_embed.json")
runner = DesignSpecRunner(spec, output_dir="./out/stress_test")
result = runner.run()
```

Or using the example script:

```bash
python scripts/run_designspec_example.py examples/stress_tests/stress_scaffold_topdown_dense_embed.json
```

## Notes

- Validity checks are mostly disabled (`validity.enable = false`) to allow the tests to proceed even with boundary violations
- Only `check_bounds` is enabled in `policies.validity`
- `keep_largest_component` is set to `false` in composition policies to preserve all generated structures
- Embedding is enabled with `preserve_ports_enabled = true`
